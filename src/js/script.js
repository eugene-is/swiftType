// const input = document.querySelector("input");
// const letters = Array.from(document.querySelectorAll("[data-letters]"));
// const specs = Array.from(document.querySelectorAll("[data-spec]"));
// const textExample = document.querySelector("#textExample");
// const symbolsPerMinute = document.querySelector("#symbolsPerMinute");
// const worldsPerMinute = document.querySelector('#worldsPerMinute')
// const timeSession = document.querySelector('#timeSession');
// const errorPercent = document.querySelector("#errorPercent");

// let text = `В начале июля, в чрезвычайно жаркое время, под вечер один молодой человек вышел из своей каморки, которую нанимал от жильцов в С-м переулке, на улицу и медленно, как бы в нерешимости, отправился к К-ну мосту.
// Он благополучно избегнул встречи с своею хозяйкой на лестнице. Каморка его приходилась под самою кровлей высокого пятиэтажного дома и походила более на шкаф, чем на квартиру. Квартирная же хозяйка его, у которой он нанимал эту каморку с обедом и прислугой, помещалась одною лестницей ниже, в отдельной квартире, и каждый раз, при выходе на улицу, ему непременно надо было проходить мимо хозяйкиной кухни, почти всегда настежь отворенной на лестницу. И каждый раз молодой человек, проходя мимо, чувствовал какое-то болезненное и трусливое ощущение, которого стыдился и от которого морщился. Он был должен кругом хозяйке и боялся с нею встретиться. Не то чтоб он был так труслив и забит, совсем даже напротив; но с некоторого времени он был в раздражительном и напряженном состоянии, похожем на ипохондрию. Он до того углубился в себя и уединился от всех, что боялся даже всякой встречи, не только встречи с хозяйкой. Он был задавлен бедностью; но даже стесненное положение перестало в последнее время тяготить его. Насущными делами своими он совсем перестал и не хотел заниматься. Никакой хозяйки, в сущности, он не боялся, что бы та ни замышляла против него. Но останавливаться на лестнице, слушать всякий вздор про всю эту обыденную дребедень, до которой ему нет никакого дела, все эти приставания о платеже, угрозы, жалобы, и при этом самому изворачиваться, извиняться, лгать, – нет уж, лучше проскользнуть как-нибудь кошкой по лестнице и улизнуть, чтобы никто не видал. Впрочем, на этот раз страх встречи с своею кредиторшей даже его самого поразил по выходе на улицу «На какое дело хочу покуситься и в то же время каких пустяков боюсь! – подумал он с странною улыбкой. – Гм… да… все в руках человека, и все-то он мимо носу проносит единственно от одной трусости… это уж аксиома… Любопытно, чего люди больше всего боятся? Нового шага, нового собственного слова они всего больше боятся… А впрочем, я слишком много болтаю. Оттого и ничего не делаю, что болтаю. Пожалуй, впрочем, и так: оттого болтаю, что ничего не делаю. Это я в этот последний месяц выучился болтать, лежа по целым суткам в углу и думая… о царе Горохе. Ну зачем я теперь иду? Разве я способен на это? Разве это серьезно? Совсем не серьезно. Так, ради фантазии сам себя тешу; игрушки! Да, пожалуй, что и игрушки!»
// На улице жара стояла страшная, к тому же духота, толкотня, всюду известка, леса, кирпич, пыль и та особенная летняя вонь, столь известная каждому петербуржцу, не имеющему возможности нанять дачу, – все это разом неприятно потрясло и без того уже расстроенные нервы юноши. Нестерпимая же вонь из распивочных, которых в этой части города особенное множество, и пьяные, поминутно попадавшиеся, несмотря на буднее время, довершили отвратительный и грустный колорит картины. Чувство глубочайшего омерзения мелькнуло на миг в тонких чертах молодого человека. Кстати, он был замечательно хорош собою, с прекрасными темными глазами, темно-рус, ростом выше среднего, тонок и строен. Но скоро он впал как бы в глубокую задумчивость, даже, вернее сказать, как бы в какое-то забытье, и пошел, уже не замечая окружающего, да и не желая его замечать. Изредка только бормотал он что-то про себя, от своей привычки к монологам, в которой он сейчас сам себе признался. В эту же минуту он и сам сознавал, что мысли его порою мешаются и что он очень слаб: второй день, как уж он почти совсем ничего не ел.
// Он был до того худо одет, что иной, даже и привычный человек, посовестился бы днем выходить в таких лохмотьях на улицу. Впрочем, квартал был таков, что костюмом здесь было трудно кого-нибудь удивить. Близость Сенной, обилие известных заведений и, по преимуществу, цеховое и ремесленное население, скученное в этих серединных петербургских улицах и переулках, пестрили иногда общую панораму такими субъектами, что странно было бы и удивляться при встрече с иною фигурой. Но столько злобного презрения уже накопилось в душе молодого человека, что, несмотря на всю свою, иногда очень молодую, щекотливость, он менее всего совестился своих лохмотьев на улице. Другое дело при встрече с иными знакомыми или с прежними товарищами, с которыми вообще он не любил встречаться… А между тем, когда один пьяный, которого неизвестно почему и куда провозили в это время по улице в огромной телеге, запряженной огромною ломовою лошадью, крикнул ему вдруг, проезжая: «Эй ты, немецкий шляпник!» – и заорал во все горло, указывая на него рукой, – молодой человек вдруг остановился и судорожно схватился за свою шляпу. Шляпа эта была высокая, круглая, циммермановская, но вся уже изношенная, совсем рыжая, вся в дырах и пятнах, без полей и самым безобразнейшим углом заломившаяся на сторону. Но не стыд, а совсем другое чувство, похожее даже на испуг, охватило его. – Я так и знал! – бормотал он в смущении, – я так и думал! Это уж всего сквернее! Вот эдакая какая-нибудь глупость, какая-нибудь пошлейшая мелочь, весь замысел может испортить! Да, слишком приметная шляпа… Смешная, потому и приметная… К моим лохмотьям непременно нужна фуражка, хотя бы старый блин какой-нибудь, а не этот урод. Никто таких не носит, за версту заметят, запомнят… главное, потом запомнят, ан и улика. Тут нужно быть как можно неприметнее… Мелочи, мелочи главное!.. вот эти-то мелочи и губят всегда и все... Идти ему было немного; он даже знал, сколько шагов от ворот его дома: ровно семьсот тридцать. Как-то раз он их сосчитал, когда уж очень размечтался. В то время он и сам еще не верил этим мечтам своим и только раздражал себя их безобразною, но соблазнительною дерзостью. Теперь же, месяц спустя, он уже начинал смотреть иначе и, несмотря на все поддразнивающие монологи о собственном бессилии и нерешимости, «безобразную» мечту как-то даже поневоле привык считать уже предприятием, хотя все еще сам себе не верил.`




// let layoutChangeFlag = true;
// if(document.querySelector('.globus-toggle')){
// 	document.querySelector('.globus-toggle').addEventListener('click', event => {
// 		event.preventDefault();
// 		layoutchange();
// 	});
// }



// function layoutchange(){
	
// 	if(layoutChangeFlag){
// 		fetch('/src/trainerText/bookEn.txt')
// 			.then(response => response.text())
// 			.then(textEn => {
// 			text = textEn;
// 			console.log(text);
// 			const randomNum = Math.floor(Math.random() * 1000);
// 			text = text.match(/[^.!?]+[.!?]+/g).slice(randomNum, randomNum + 20).join('').slice(1);
// 			party = createParty(text);
// 			init();
// 		});
// 	}
// 	else{
// 		fetch('/src/trainerText/bookRus.txt')
// 			.then(response => response.text())
// 			.then(textRus => {
// 			text = textRus;
// 			const randomNum = Math.floor(Math.random() * 1000);
// 			text = text.match(/[^.!?]+[.!?]+/g).slice(randomNum, randomNum + 20).join('').slice(1);
// 			party = createParty(text);
// 			init();
// 		});
// 	}

// 	layoutChangeFlag = !layoutChangeFlag;
// }

// let party = createParty(text);








// //const party = createParty(text);
// if(document.querySelector('.trainer__keyboard')) init();

// function init() {
// 	input.addEventListener("keydown", keydownHandler);
// 	input.addEventListener("keyup", keyupHandler);

// 	viewUpdate();
// }

// function keydownHandler(event) {
// 	event.preventDefault();

// 	const letter = letters.find((x) => x.dataset.letters.includes(event.key));
// 	if (letter) {
// 		letter.classList.add("pressed");
// 		press(event.key);
// 		return;
// 	}

// 	let key = event.key.toLowerCase();
// 	if (key === 'escape'){
// 		press('escape');
// 	}

// 	if (key === " ") {
// 		key = "space";
// 		press(" ");
// 	}

// 	if (key === "enter") {
// 		press("\n");
// 	}

// 	const ownSpecs = specs.filter((x) => x.dataset.spec === key);

// 	if (ownSpecs.length) {
// 		ownSpecs.forEach((spec) => spec.classList.add("pressed"));
// 		return;
// 	}
// 	console.warn("Не известный вид клавиши.", event);
// }

// function keyupHandler(event) {
// 	event.preventDefault();

// 	const letter = letters.find((x) => x.dataset.letters.includes(event.key));

// 	if (letter) {
// 		letter.classList.remove("pressed");

// 		return;
// 	}

// 	let key = event.key.toLowerCase();

// 	if (key === " ") {
// 		key = "space";
// 	}

// 	const ownSpecs = specs.filter((x) => x.dataset.spec === key);

// 	if (ownSpecs.length) {
// 		ownSpecs.forEach((spec) => spec.classList.remove("pressed"));
// 		return;
// 	}
// }

// function createParty(text) {
// 	const party = {
// 		text,
// 		strings: [],
// 		maxStringLength: 70,
// 		maxShowStrings: 3,
// 		currentStringIndex: 0,
// 		currentPressedIndex: 0,
// 		errors: [],
// 		started: false,

// 		statisticFlag: false,
// 		timerCounter: 0,
// 		startTimer: 0,
// 		wordCounter: 0,
// 		errorCounter: 0,
// 		commonCounter: 0,
// 	};

// 	party.text = party.text.replace(/\n/g, "\n ");
// 	const words = party.text.split(" ");
// 	let string = [];
// 	for (const word of words) {
// 		const newStringLength =
// 			[...string, word].join(" ").length + !word.includes("\n");

// 		if (newStringLength > party.maxStringLength) {
// 			party.strings.push(string.join(" ") + " ");
// 			string = [];
// 		}

// 		string.push(word);

// 		if (word.includes("\n")) {
// 			party.strings.push(string.join(" "));
// 			string = [];
// 		}
// 	}

// 	if (string.length) {
// 		party.strings.push(string.join(" "));
// 	}

// 	return party;
// }

// function press(letter) {
// 	party.started = true;

// 	if (!party.statisticFlag) {
// 		party.wordCounter = 0;
// 		party.commonCounter = 0;
// 		party.statisticFlag = true;
// 		party.startTimer = Date.now();
// 	}

// 	if(letter === ' '){
// 		party.wordCounter++;
// 	}


// 	if(letter === 'escape'){
// 		party.statisticFlag = false;
// 		party.timerCounter = Date.now() - party.startTimer;
// 	}
// 	const string = party.strings[party.currentStringIndex];
// 	const mustLetter = string[party.currentPressedIndex];
	
// 	if (letter === mustLetter || letter === 'escape') {
// 		party.currentPressedIndex++;
// 		if (string.length <= party.currentPressedIndex) {
// 			party.currentPressedIndex = 0;
// 			party.currentStringIndex++;
// 		}
// 	} else if (!party.errors.includes(mustLetter)) {
// 		party.errors.push(mustLetter);
// 		party.errorCounter++;
// 	}

// 	party.commonCounter++;
// 	input.classList.remove('inputError');
// 	viewUpdate();
// }

// function viewUpdate() {
// 	const string = party.strings[party.currentStringIndex];

// 	const showedStrings = party.strings.slice(
// 		party.currentStringIndex,
// 		party.currentStringIndex + party.maxShowStrings
// 	);

// 	const div = document.createElement("div");

// 	const firstLine = document.createElement("div");
// 	firstLine.classList.add("line");
// 	div.append(firstLine);

// 	const done = document.createElement("span");
// 	done.classList.add("done");
// 	done.textContent = string.slice(0, party.currentPressedIndex);
// 	firstLine.append(
// 		done,
// 		...string
// 			.slice(party.currentPressedIndex)
// 			.split("")
// 			.map((letter) => {
// 				if (party.errors.includes(letter)) {
// 					input.classList.add('inputError');
// 					const errorSpan = document.createElement("span");
// 					errorSpan.classList.add("hint");
// 					errorSpan.textContent = letter;
// 					return errorSpan;
// 				}
				
// 				if (letter === " ") {
// 					return "·";
// 				}

// 				if (letter === "\n") {
// 					return "¶";
// 				}

// 				party.errors = [];

// 				return letter;
// 			})
// 	);

// 	for (let i = 1; i < showedStrings.length; i++) {
// 		const line = document.createElement("div");
// 		line.classList.add("line");
// 		div.append(line);

// 		line.append(
// 			...showedStrings[i].split("").map((letter) => {
// 				if (party.errors.includes(letter)) {
// 					input.classList.add('inputError');
// 					const errorSpan = document.createElement("span");
// 					errorSpan.classList.add("hint");
// 					errorSpan.textContent = letter;
// 					return errorSpan;
// 				}
				
// 				if (letter === " ") {
// 					return "·";
// 				}

// 				if (letter === "\n") {
// 					return "¶";
// 				}
				
// 				party.errors = [];

// 				return letter;
// 			})
// 		);
// 	}

// 	textExample.innerHTML = "";
// 	textExample.append(div);

// 	input.value = string.slice(0, party.currentPressedIndex);

// 	if (!party.statisticFlag && party.started) {
// 		party.commonCounter--;
// 		party.errorCounter--;
// 		symbolsPerMinute.textContent = Math.round((60000 * party.commonCounter) / party.timerCounter);
// 		worldsPerMinute.textContent = Math.round((60000 * party.wordCounter) / party.timerCounter);
// 		timeSession.textContent = Math.round(party.timerCounter / 1000) + 'с';
// 		errorPercent.textContent = Math.floor((party.errorCounter / party.commonCounter) * 100) + '%';
// 	}
// }












const input = document.querySelector("input");
const letters = Array.from(document.querySelectorAll("[data-letters]"));
const specs = Array.from(document.querySelectorAll("[data-spec]"));
const textExample = document.querySelector("#textExample");
const symbolsPerMinute = document.querySelector("#symbolsPerMinute");
const worldsPerMinute = document.querySelector('#worldsPerMinute')
const timeSession = document.querySelector('#timeSession');
const errorPercent = document.querySelector("#errorPercent");


let layoutChangeFlag = false;

if(document.querySelector('.trainer__keyboard')) layoutChange();

if(document.querySelector('.globus-toggle')){
	document.querySelector('.globus-toggle').addEventListener('click', event => {
		event.preventDefault();
		layoutChange();
	});
}

function layoutChange(){
	if(layoutChangeFlag){
		fetch('/src/trainerText/bookEn.txt')
			.then(response => response.text())
			.then(textEn => {
			text = textEn;
			console.log(text);
			const randomNum = Math.floor(Math.random() * 1000);
			text = text.match(/[^.!?]+[.!?]+/g).slice(randomNum, randomNum + 20).join('').slice(1);
			party = createParty(text);
			init();
		});
	}
	else{
		fetch('/src/trainerText/bookRus.txt')
			.then(response => response.text())
			.then(textRus => {
			text = textRus;
			const randomNum = Math.floor(Math.random() * 1000);
			text = text.match(/[^.!?]+[.!?]+/g).slice(randomNum, randomNum + 20).join('').slice(1);
			party = createParty(text);
			init();
		});
	}
	
	layoutChangeFlag = !layoutChangeFlag;
}

function init() {
	input.addEventListener("keydown", keydownHandler);
	input.addEventListener("keyup", keyupHandler);

	viewUpdate();
}

function keydownHandler(event) {
	event.preventDefault();

	const letter = letters.find((x) => x.dataset.letters.includes(event.key));
	if (letter) {
		letter.classList.add("pressed");
		press(event.key);
		return;
	}

	let key = event.key.toLowerCase();
	if (key === 'escape'){
		press('escape');
	}

	if (key === " ") {
		key = "space";
		press(" ");
	}

	if (key === "enter") {
		press("\n");
	}

	const ownSpecs = specs.filter((x) => x.dataset.spec === key);

	if (ownSpecs.length) {
		ownSpecs.forEach((spec) => spec.classList.add("pressed"));
		return;
	}
	console.warn("Не известный вид клавиши.", event);
}

function keyupHandler(event) {
	event.preventDefault();

	const letter = letters.find((x) => x.dataset.letters.includes(event.key));

	if (letter) {
		letter.classList.remove("pressed");

		return;
	}

	let key = event.key.toLowerCase();

	if (key === " ") {
		key = "space";
	}

	const ownSpecs = specs.filter((x) => x.dataset.spec === key);

	if (ownSpecs.length) {
		ownSpecs.forEach((spec) => spec.classList.remove("pressed"));
		return;
	}
}

function createParty(text) {
	const party = {
		text,
		strings: [],
		maxStringLength: 70,
		maxShowStrings: 3,
		currentStringIndex: 0,
		currentPressedIndex: 0,
		errors: [],
		started: false,

		statisticFlag: false,
		timerCounter: 0,
		startTimer: 0,
		wordCounter: 0,
		errorCounter: 0,
		commonCounter: 0,
	};

	party.text = party.text.replace(/\n/g, "\n ");
	const words = party.text.split(" ");
	let string = [];
	for (const word of words) {
		const newStringLength =
			[...string, word].join(" ").length + !word.includes("\n");

		if (newStringLength > party.maxStringLength) {
			party.strings.push(string.join(" ") + " ");
			string = [];
		}

		string.push(word);

		if (word.includes("\n")) {
			party.strings.push(string.join(" "));
			string = [];
		}
	}

	if (string.length) {
		party.strings.push(string.join(" "));
	}

	return party;
}

function press(letter) {
	party.started = true;

	if (!party.statisticFlag) {
		party.wordCounter = 0;
		party.commonCounter = 0;
		party.statisticFlag = true;
		party.startTimer = Date.now();
	}

	if(letter === ' '){
		party.wordCounter++;
	}


	if(letter === 'escape'){
		party.statisticFlag = false;
		party.timerCounter = Date.now() - party.startTimer;
	}
	const string = party.strings[party.currentStringIndex];
	const mustLetter = string[party.currentPressedIndex];
	
	if (letter === mustLetter || letter === 'escape') {
		party.currentPressedIndex++;
		if (string.length <= party.currentPressedIndex) {
			party.currentPressedIndex = 0;
			party.currentStringIndex++;
		}
	} else if (!party.errors.includes(mustLetter)) {
		party.errors.push(mustLetter);
		party.errorCounter++;
	}

	party.commonCounter++;
	input.classList.remove('inputError');
	viewUpdate();
}

function viewUpdate() {
	const string = party.strings[party.currentStringIndex];

	const showedStrings = party.strings.slice(
		party.currentStringIndex,
		party.currentStringIndex + party.maxShowStrings
	);

	const div = document.createElement("div");

	const firstLine = document.createElement("div");
	firstLine.classList.add("line");
	div.append(firstLine);

	const done = document.createElement("span");
	done.classList.add("done");
	done.textContent = string.slice(0, party.currentPressedIndex);
	firstLine.append(
		done,
		...string
			.slice(party.currentPressedIndex)
			.split("")
			.map((letter) => {
				if (party.errors.includes(letter)) {
					input.classList.add('inputError');
					const errorSpan = document.createElement("span");
					errorSpan.classList.add("hint");
					errorSpan.textContent = letter;
					return errorSpan;
				}
				
				if (letter === " ") {
					return "·";
				}

				if (letter === "\n") {
					return "¶";
				}

				party.errors = [];

				return letter;
			})
	);

	for (let i = 1; i < showedStrings.length; i++) {
		const line = document.createElement("div");
		line.classList.add("line");
		div.append(line);

		line.append(
			...showedStrings[i].split("").map((letter) => {
				if (party.errors.includes(letter)) {
					input.classList.add('inputError');
					const errorSpan = document.createElement("span");
					errorSpan.classList.add("hint");
					errorSpan.textContent = letter;
					return errorSpan;
				}
				
				if (letter === " ") {
					return "·";
				}

				if (letter === "\n") {
					return "¶";
				}
				
				party.errors = [];

				return letter;
			})
		);
	}

	textExample.innerHTML = "";
	textExample.append(div);

	input.value = string.slice(0, party.currentPressedIndex);

	if (!party.statisticFlag && party.started) {
		party.commonCounter--;
		party.errorCounter--;
		symbolsPerMinute.textContent = Math.round((60000 * party.commonCounter) / party.timerCounter);
		worldsPerMinute.textContent = Math.round((60000 * party.wordCounter) / party.timerCounter);
		timeSession.textContent = Math.round(party.timerCounter / 1000) + 'с';
		errorPercent.textContent = Math.floor((party.errorCounter / party.commonCounter) * 100) + '%';
	}
}